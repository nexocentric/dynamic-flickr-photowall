<!DOCTYPE html>
<html class="no-js" lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width">

		<link rel="stylesheet" href="stylesheets/site.css">
		<script type="text/javascript" src="javascripts/modernizr.js"></script>
		<script type="text/javascript">
			//&api_key=25b7fb5c323fa75fe2392cea1ee1d902&user_id=42488861%40N06&format=rest&api_sig=209f2d5441959dcf4f75e49a55b6fdb3
			var flickrKey = "76f3106f7634258dce78cd44e03e8b76";
			var flickrSecret = "0e017d4172b1b622";
			var flickrUserId = "42488861@N06";
			var ajaxHandlerPath = 'https://api.flickr.com/services/rest?format=json&jsoncallback=?';
			var timestampAttribute = "data_upload_timestamp";
			var ajaxRequest = null;
			var ajaxTimeout = 300000;
			var flickrOptions = "";
			var displayPhotos = "";
			var maxDisplayNumber = 12;
			var getMaxFromFlickr = maxDisplayNumber;

			Array.prototype.diff = function(a) {
			    return this.filter(function(i) {return a.indexOf(i) < 0;});
			};

			function addImage(imagePath, uploadTimestamp, jqueryObject) {
				var img = $('<img class="photo" width="100%" alt="">').attr('src', imagePath).attr(timestampAttribute, uploadTimestamp).load(function() {
					if (!this.complete || typeof this.naturalWidth == "undefined" || this.naturalWidth == 0) {
						console.log('broken image!');
					} else {
						//$('[' + timestampAttribute + '="' + uploadTimestamp + '"] > div').append(img);
						$(jqueryObject).first().replaceWith(img);
					}
				});
			}

			function deleteImage(timestamp) {
				console.log('DELETE THIS TIMESTAMP ONLY:[' + timestamp + ']');
				$('img[' + timestampAttribute + '="' + timestamp + '"]').replaceWith('<span>&nbsp;</span>');
				//$('img').remove('[' + timestampAttribute + '="' + timestamp + '"]');
				//$('li').remove('[' + timestampAttribute + '="' + timestamp + '"]');
			}

			function getNewestFlickrTimestamps(list) {
				var photoIndex = 0;
				var timestampList = new Array();
				for (var photoIndex = 0; photoIndex < photoList.length; photoIndex++) {
					if (
						typeof photoList[photoIndex].url_b === 'undefined'
						&& typeof photoList[photoIndex].url_c === 'undefined'
						&& typeof photoList[photoIndex].url_z === 'undefined'
					) {
						console.log("size is undefined for");
						continue;	
					}
					//if (photoList[photoIndex].url_b || photoList[photoIndex].url_c || photoList[photoIndex].url_z) {
						console.log('newest[' + photoIndex + ']:' + photoList[photoIndex].dateupload)
						timestampList.push(photoList[photoIndex].dateupload);
					//}
				}
				// timestampList.sort();
				// timestampList = timestampList.reverse();
				return timestampList.slice(0, maxDisplayNumber);
			}

			function getUploadTimestampsFromPhotoWall() {
				var timestampList = new Array();

				$('.photo').each(function() {
					timestampList.push($(this).attr(timestampAttribute));
					console.log('currently displayed:' + $(this).attr(timestampAttribute));
				});
				return timestampList;
			}

			function filterPhotosForDisplay(oldList, newList) {
				var filteredList = new Array();
				for (var itemIndex = 0; itemIndex < oldList.length; itemIndex++) {
					if(alreadyDisplayed(newList, oldList)) {
						continue;
					}
					filteredList.push(newList[itemIndex]);
				};
				return filteredList;
			}

			function alreadyDisplayed(uploadTimestamp, oldList) {
				for (var itemIndex = 0; itemIndex < oldList.length; itemIndex++) {
					if(uploadTimestamp == oldList[itemIndex]) {
						return true;
					}
				}
				return false;
			}

			//+ Jonas Raoni Soares Silva
			//@ http://jsfromhell.com/array/shuffle [v1.0]
			function shuffleArray(o){ //v1.0
				for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
				return o;
			};

			function parseNewestPhotoList(json) {

				photoList = json.photos.photo;

				if ($('.photo-frame > img').length == 0) {
					photoList = shuffleArray(photoList);	
				};
				
				newestFlickrPhotosTimestamps = getNewestFlickrTimestamps(photoList);
				photoWallTimestamps = getUploadTimestampsFromPhotoWall();
				displayList = newestFlickrPhotosTimestamps.diff(photoWallTimestamps);
				deleteList = photoWallTimestamps.diff(newestFlickrPhotosTimestamps);
				console.log('display list:' + displayList);
				console.log('list of photos to delete:' + deleteList);

				for (var photoIndex = 0; photoIndex < deleteList.length; photoIndex++) {
					deleteImage(deleteList[photoIndex]);
				};

				availablePhotoFrames = $('.photo-frame > span');

				var photoIndex = 0;
				var upperLimit = $(availablePhotoFrames).length;
				if (upperLimit > 0) {
					upperLimit = upperLimit;
				}
				displayList = displayList.slice(0, upperLimit);
				for (var photoIndex = 0; photoIndex < displayList.length; photoIndex++) {
					if (alreadyDisplayed(photoList[photoIndex].dateupload, deleteList)) {
						console.log('picture skipped');
						continue;
					}

					if (photoList[photoIndex].url_b) {
						addImage(photoList[photoIndex].url_b, photoList[photoIndex].dateupload, availablePhotoFrames[photoIndex]);
					} else if (photoList[photoIndex].url_c) {
						addImage(photoList[photoIndex].url_c, photoList[photoIndex].dateupload, availablePhotoFrames[photoIndex]);
					} else if (photoList[photoIndex].url_z) {
						addImage(photoList[photoIndex].url_z, photoList[photoIndex].dateupload, availablePhotoFrames[photoIndex]);
					}
				}
			}

			function startPoll() {
				setTimeout(pollFlickrServer, 5000);
			}

			function pollFlickrServer() {
				//----------------------------------
				// make the AJAX call and wait
				// for a reply from PHP
				//----------------------------------
				$.ajax({
					url: ajaxHandlerPath,
					type: 'POST',
					data: {
						api_key: flickrKey,
						method: 'flickr.photos.search',
						privacy_filter: 1,
						content_type: 1,
						per_page: getMaxFromFlickr,
						user_id: '42488861@N06',
						extras: 'date_upload,url_b,url_c,url_z,url_n'
					},
					success: parseNewestPhotoList,
					dataType: 'json',
					complete: startPoll, // this is the key to long polling
					timeout: ajaxTimeout
				});
				//$.getJSON(ajaxHandlerPath, flickrOptions, displayPhotos);
			}
		</script>

		<p>Simple Page With Javascript</p>

		<button onclick="pollFlickrServer();">
			Hello
		</button>

		<ul id="dynamic-photo-wall" class="small-block-grid-2 medium-block-grid-3 large-block-grid-4">
			<li>
				<div id="frame1" class="photo-frame"><span>&nbsp;</span></div>
			</li>
			<li>
				<div id="frame2" class="photo-frame"><span>&nbsp;</span></div>
			</li>
			<li>
				<div id="frame3" class="photo-frame"><span>&nbsp;</span></div>
			</li>
			<li>
				<div id="frame4" class="photo-frame"><span>&nbsp;</span></div>
			</li>
			<li>
				<div id="frame5" class="photo-frame"><span>&nbsp;</span></div>
			</li>
			<li>
				<div id="frame6" class="photo-frame"><span>&nbsp;</span></div>
			</li>
			<li>
				<div id="frame7" class="photo-frame"><span>&nbsp;</span></div>
			</li>
			<li>
				<div id="frame8" class="photo-frame"><span>&nbsp;</span></div>
			</li>
			<li>
				<div id="frame9" class="photo-frame"><span>&nbsp;</span></div>
			</li>
			<li>
				<div id="frame10" class="photo-frame"><span>&nbsp;</span></div>
			</li>
			<li>
				<div id="frame11" class="photo-frame"><span>&nbsp;</span></div>
			</li>
			<li>
				<div id="frame12" class="photo-frame"><span>&nbsp;</span></div>
			</li>
		</ul>

		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
		<script type="text/javascript">
			$.fn.exists = function () {
				return this.length !== 0;
			}
		</script>


		<!-- start foundation includes -->
		<script type="text/javascript" src="javascripts/foundation.js"></script>
		<script type="text/javascript" src="javascripts/foundation.abide.js"></script>
		<script type="text/javascript" src="javascripts/foundation.accordion.js"></script>
		<script type="text/javascript" src="javascripts/foundation.alert.js"></script>
		<script type="text/javascript" src="javascripts/foundation.clearing.js"></script>
		<script type="text/javascript" src="javascripts/foundation.dropdown.js"></script>
		<script type="text/javascript" src="javascripts/foundation.equalizer.js"></script>
		<script type="text/javascript" src="javascripts/foundation.interchange.js"></script>
		<script type="text/javascript" src="javascripts/foundation.joyride.js"></script>
		<script type="text/javascript" src="javascripts/foundation.magellan.js"></script>
		<script type="text/javascript" src="javascripts/foundation.offcanvas.js"></script>
		<script type="text/javascript" src="javascripts/foundation.orbit.js"></script>
		<script type="text/javascript" src="javascripts/foundation.reveal.js"></script>
		<script type="text/javascript" src="javascripts/foundation.tab.js"></script>
		<script type="text/javascript" src="javascripts/foundation.tooltip.js"></script>
		<script type="text/javascript" src="javascripts/foundation.topbar.js"></script>

		<!-- foundation initalizations -->
		<script>$(document).foundation();</script>
		<!-- end foundation includes -->

	</body>
</html>